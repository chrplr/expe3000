name: Build and Release expe3000

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake pkg-config build-essential ninja-build tar \
          libasound2-dev libpulse-dev libdbus-1-dev libwayland-dev \
          libx11-dev libxcursor-dev libxext-dev libxi-dev libxinerama-dev \
          libxrandr-dev libxss-dev libxtst-dev libjpeg-dev libpng-dev \
          libwebp-dev libfreetype6-dev libharfbuzz-dev

    - name: Build SDL3
      run: |
        git clone --depth 1 https://github.com/libsdl-org/SDL.git
        cd SDL && mkdir build && cd build
        cmake -G Ninja -DCMAKE_BUILD_TYPE=Release ..
        cmake --build .
        sudo cmake --install .

    - name: Build SDL3_image
      run: |
        git clone --depth 1 https://github.com/libsdl-org/SDL_image.git
        cd SDL_image && mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release ..
        cmake --build .
        sudo cmake --install .

    - name: Build SDL3_ttf
      run: |
        git clone --depth 1 https://github.com/libsdl-org/SDL_ttf.git
        cd SDL_ttf && mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release ..
        cmake --build .
        sudo cmake --install .

    - name: Configure and Build expe3000
      run: |
        sudo ldconfig
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Package Linux
      run: |
        mkdir -p release-linux
        cp build/expe3000 release-linux/
        cp README.md release-linux/
        cp experiment.csv release-linux/
        cp run_example.sh release-linux/
        chmod +x release-linux/run_example.sh
        cp -r assets release-linux/
        cp -r fonts release-linux/
        tar -czvf expe3000-linux.tar.gz -C release-linux .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: expe3000-linux
        path: expe3000-linux.tar.gz

  tag-release:
    needs: build-linux
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version
      id: get_version
      run: |
        VERSION=$(grep "EXPE3000_VERSION" include/version.h | cut -d '"' -f 2)
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Check if tag exists
      id: check_tag
      run: |
        if git rev-parse "${{ steps.get_version.outputs.VERSION }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Create and push tag
      if: github.ref == 'refs/heads/main' && steps.check_tag.outputs.exists == 'false'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag ${{ steps.get_version.outputs.VERSION }}
        git push origin ${{ steps.get_version.outputs.VERSION }}

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        brew update
        brew install sdl3 sdl3_image sdl3_ttf cmake pkg-config ninja

    - name: Configure and Build
      run: |
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Package macOS
      run: |
        mkdir -p release-macos
        cp build/expe3000 release-macos/
        cp README.md release-macos/
        cp README.md release-macos/README.txt
        cp experiment.csv release-macos/
        cp run_example.sh release-macos/
        chmod +x release-macos/run_example.sh
        cp -r assets release-macos/
        cp -r fonts release-macos/
        cd release-macos && zip -r ../expe3000-macos.zip .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: expe3000-macos
        path: expe3000-macos.zip

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-sdl3
          mingw-w64-x86_64-sdl3-image
          mingw-w64-x86_64-sdl3-ttf
          mingw-w64-x86_64-pkgconf
          zip

    - name: Configure and Build
      shell: msys2 {0}
      run: |
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Package Windows (with DLLs)
      shell: msys2 {0}
      run: |
        mkdir -p release-windows
        cp build/expe3000.exe release-windows/
        cp README.md release-windows/
        cp README.md release-windows/README.txt
        cp experiment.csv release-windows/
        cp run_example.bat release-windows/
        cp -r assets release-windows/
        cp -r fonts release-windows/
        # Collect all required MinGW DLLs automatically
        cp $(ldd build/expe3000.exe | grep /mingw64/bin | awk '{print $3}') release-windows/
        cd release-windows && zip -r ../expe3000-windows.zip .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: expe3000-windows
        path: expe3000-windows.zip

  create-release:
    needs: [build-linux, build-macos, build-windows, tag-release]
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag-release.outputs.version }}
          files: |
            artifacts/expe3000-linux.tar.gz
            artifacts/expe3000-macos.zip
            artifacts/expe3000-windows.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
