name: Build and Release expe3000

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake pkg-config build-essential ninja-build tar \
          libasound2-dev libpulse-dev libdbus-1-dev libwayland-dev \
          libx11-dev libxcursor-dev libxext-dev libxi-dev libxinerama-dev \
          libxrandr-dev libxss-dev libxtst-dev libjpeg-dev libpng-dev \
          libwebp-dev libfreetype6-dev libharfbuzz-dev

    - name: Build SDL3
      run: |
        git clone --depth 1 https://github.com/libsdl-org/SDL.git
        cd SDL && mkdir build && cd build
        cmake -G Ninja -DCMAKE_BUILD_TYPE=Release ..
        cmake --build .
        sudo cmake --install .

    - name: Build SDL3_image
      run: |
        git clone --depth 1 https://github.com/libsdl-org/SDL_image.git
        cd SDL_image && mkdir build && cd build
        cmake -G Ninja -DCMAKE_BUILD_TYPE=Release ..
        cmake --build .
        sudo cmake --install .

    - name: Build SDL3_ttf
      run: |
        git clone --depth 1 https://github.com/libsdl-org/SDL_ttf.git
        cd SDL_ttf && mkdir build && cd build
        cmake -G Ninja -DCMAKE_BUILD_TYPE=Release ..
        cmake --build .
        sudo cmake --install .

    - name: Configure and Build expe3000
      run: |
        sudo ldconfig
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Package Linux
      run: |
        mkdir -p release-linux
        cp build/expe3000 release-linux/
        tar -czvf expe3000-linux.tar.gz -C release-linux expe3000

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: expe3000-linux
        path: expe3000-linux.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        brew update
        brew install sdl3 sdl3_image sdl3_ttf cmake pkg-config ninja

    - name: Configure and Build
      run: |
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Package macOS
      run: |
        mkdir -p release-macos
        cp build/expe3000 release-macos/
        zip -j expe3000-macos.zip release-macos/expe3000

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: expe3000-macos
        path: expe3000-macos.zip

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-zip
          mingw-w64-x86_64-sdl3
          mingw-w64-x86_64-sdl3-image
          mingw-w64-x86_64-sdl3-ttf
          mingw-w64-x86_64-pkgconf

    - name: Configure and Build
      shell: msys2 {0}
      run: |
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Package Windows (with DLLs)
      shell: msys2 {0}
      run: |
        mkdir -p release-windows
        cp build/expe3000.exe release-windows/
        # Collect all required MinGW DLLs automatically
        cp $(ldd build/expe3000.exe | grep /mingw64/bin | awk '{print $3}') release-windows/
        zip -j expe3000-windows.zip release-windows/*

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: expe3000-windows
        path: expe3000-windows.zip

  create-release:
    needs: [build-linux, build-macos, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/expe3000-linux.tar.gz
            artifacts/expe3000-macos.zip
            artifacts/expe3000-windows.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
